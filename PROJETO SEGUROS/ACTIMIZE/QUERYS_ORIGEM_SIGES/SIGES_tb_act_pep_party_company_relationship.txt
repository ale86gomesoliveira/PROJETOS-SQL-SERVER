WITH MAX_DT_REVALI
AS
(SELECT 
	pr.CD_CONTROLE, 
	MAX(DT_REVALIDACAO) AS DT_REVALIDA 
	FROM DBTCTO.TB_PEP_PESSOAS_RELACOES PR --WHERE PR.cd_controle IN ('063020728','010328523')
	GROUP BY CD_CONTROLE
)
SELECT 
TRIM(pr.CD_CONTROLE CONCAT CD_VERIFICADOR) AS Control_Id,
CD_FILIAL AS Branch_Cd,
CD_VERIFICADOR AS Verification_Cd,
CASE 
	WHEN CD_RELACAO = '1' THEN 'FUNCIONÁRIO'
	WHEN CD_RELACAO = '2'  THEN 'CLIENTE'
	WHEN CD_RELACAO = '3'  THEN 'FRANQUEADO'
	WHEN CD_RELACAO = '4'  THEN 'PRESTADOR'
	WHEN CD_RELACAO = '5'  THEN 'CANDI FRANQUE'
	WHEN CD_RELACAO = '6'  THEN 'CANDI FUNCIO'	
	WHEN CD_RELACAO = '7'  THEN 'EVENTUAL'
	WHEN CD_RELACAO = '8'  THEN 'SÓCIO FRANQUEADO'
	WHEN CD_RELACAO = '9'  THEN 'PRESTADOR KYOEI'
	WHEN CD_RELACAO = '10' THEN 'CLIENTE KYOEI'
	WHEN CD_RELACAO = '11' THEN 'FUNCIONARIO KYOEI'
	WHEN CD_RELACAO = '12' THEN 'CLIENTE VG'
	WHEN CD_RELACAO = '13' THEN 'CORRETOR VG'
	WHEN CD_RELACAO = '14' THEN 'PRESTADOR VG'
	WHEN CD_RELACAO = '15' THEN 'FAVORECIDO'
	WHEN CD_RELACAO = '16' THEN 'SEGURADO VG'
	WHEN CD_RELACAO = '17' THEN 'BENEFICIARIO VG'
	WHEN CD_RELACAO = '18' THEN 'SUBESTIPULANTE VG'
	WHEN CD_RELACAO = '19' THEN 'POTENCIAL CLIENTE'
	WHEN CD_RELACAO = '20' THEN 'teste'
	WHEN CD_RELACAO = '21' THEN 'Teste'
	WHEN CD_RELACAO = '22' THEN 'FAVORE MASSIFICA'
END Relationship_tx, 
ST_RELACAO AS Relationship_status_tx,
DT_REVALIDACAO AS Revalidation_Date_Dt
FROM DBTCTO.TB_PEP_PESSOAS_RELACOES PR 
INNER JOIN MAX_DT_REVALI mdr ON pr.DT_REVALIDACAO = mdr.dt_revalida
--WHERE PR.cd_controle IN ('063020728','010328523')
GROUP BY
PR.CD_CONTROLE,
CD_FILIAL,
CD_VERIFICADOR,
CD_RELACAO,
ST_RELACAO,
DT_REVALIDACAO