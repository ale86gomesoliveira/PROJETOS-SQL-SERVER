CREATE OR ALTER PROCEDURE dbo.PRC_INSERT_LOG (@NM_TABELA VARCHAR(200), @NR_STATUS INT, @NM_STATUS VARCHAR(5), @ENT int)
AS

BEGIN 
	DECLARE @DATA_INICIO DATETIME
	DECLARE @DATA_FIM DATETIME
	DECLARE @SCRIPT_QTD VARCHAR(4000)
	DECLARE @NR_LINHAS INT
	DECLARE @MAX_ID_LOG INT
	DECLARE @MIN_ID_LOG INT
	DECLARE @DIFF_TIME INT

	SET @DATA_INICIO = GETDATE()
	SET @DATA_FIM = GETDATE()

	SET @MAX_ID_LOG = (SELECT MAX(NR_Codigo) FROM ATUARIAL_IFRS17_GAAPTI..TB_LOG_INSERT WHERE NM_NOME_TABELA = @NM_TABELA AND DT_DATA_END IS NULL)

	IF @ENT = 1
		INSERT INTO ATUARIAL_IFRS17_GAAPTI..TB_LOG_INSERT(NM_NOME_TABELA, DT_DATA_START, NR_STATUS, NM_STATUS) VALUES (@NM_TABELA , @DATA_INICIO, -1, 'PROC')
	ELSE
	BEGIN
		/*Deleta caso exista um registro da tabela em processamento*/
		DELETE FROM ATUARIAL_IFRS17_GAAPTI..TB_AUX_QTD_LINHAS WHERE NOME_TABELA =  @NM_TABELA;

		--SET @SCRIPT_QTD = 'SELECT COUNT(*) AS QTD_LINHAS, ' + @NM_TABELA + ' AS NOME_TABELA INTO TB_AUX_QTD_LINHAS FROM ATUARIAL_IFRS17_GAAPTI..' + @NM_TABELA
		SET @SCRIPT_QTD =  'INSERT INTO ATUARIAL_IFRS17_GAAPTI..TB_AUX_QTD_LINHAS SELECT ''' + @NM_TABELA + ''' AS NOME_TABELA, COUNT(*) AS QTD_LINHAS FROM ATUARIAL_IFRS17_GAAPTI..' + @NM_TABELA

		EXEC (@SCRIPT_QTD)

		SET @NR_LINHAS = (SELECT QTD_LINHAS FROM ATUARIAL_IFRS17_GAAPTI..TB_AUX_QTD_LINHAS WHERE NOME_TABELA = @NM_TABELA)

		/*Atualiza ultimo registro de log, com data de finalização, status e quentidade de registros*/		 
		UPDATE ATUARIAL_IFRS17_GAAPTI..TB_LOG_INSERT
		SET 
			DT_DATA_END = @DATA_FIM,
			NR_LINHAS = @NR_LINHAS,
			NR_STATUS = @NR_STATUS,
			NM_STATUS = @NM_STATUS
		WHERE
			NR_Codigo = @MAX_ID_LOG
		
		
		/*Atualiza registros que não foram concluidos*/
		UPDATE ATUARIAL_IFRS17_GAAPTI..TB_LOG_INSERT
		SET 
			DT_DATA_END = @DATA_FIM,
			NR_LINHAS = 0,
			NR_STATUS = 0,
			NM_STATUS = 'NOK'
		WHERE
			NR_STATUS = -1
			and NM_NOME_TABELA = @NM_TABELA
		
	END
END